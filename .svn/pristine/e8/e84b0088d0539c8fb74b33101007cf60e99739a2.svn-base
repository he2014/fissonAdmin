$(document).ready(function () {
    var stringFormat = util.String.stringFormat;
    var template = {
        Main: '<tr class="mains">\
                <td class="miandd ">{0}</td> \
                <td class="miandd ">{1}</td>\
                <td class="miandd ">{2}</td>\
                <td class="miandd ">{3}</td>\
            </tr>',
        list: '<div id="{1}" data-id="{3}" class="{2}">{0}</div>',
        btn: '<div id="functonBtn">\
        <input id="functonBtn_add" class="btn btn-primary radius" type="button" value="添加">\
        <input id="functonBtn_edit" class="btn btn-primary radius" type="button" value="修改">\
        <input id="functonBtn_delete" class="btn btn-danger radius" type="button" value="删除">\
        </div>'
    }

    var page = {
        init: function () {
            this.getFunction();
        },
        getFunction: function () {
            var _this = this;
            $("#functionTable").html(" ");
            getAjax("function/list", {}, function (data) {
                console.log(data)
                if (data.code == 0) {
                    var datas = data.dataInfo;
                    datas.forEach(function (item) {
                        var firstTd = '', sencendTd = "", thirdTd = "", endTd = "",arr=[];
                        var firstCalss = "", sencendClass = "", thirdCalss = "", endClass = "";
                        firstTd = stringFormat(template.list, item.name, item.id, "Main" + item.id, item.id);
                        firstCalss = "Main" + item.id;
                        if (item.childs && item.childs.length > 0) {
                            item.childs.forEach(function (ele, i) {
                                sencendTd += stringFormat(template.list, ele.name, ele.id, "sencendTd" + ele.pId, ele.id);
                                sencendClass = "sencendTd" + ele.pId
                                if (ele.childs && ele.childs.length > 0) {
                                    ele.childs.forEach(function (key) {
                                        arr.push(key.id);
                                        thirdTd += stringFormat(template.list, key.name,"thirdTd"+ key.id, "thirdTd" + key.pId, key.id);
                                        thirdCalss = "thirdTd" + key.pId;
                                        if (key.functionInfoBeans && key.functionInfoBeans.length > 0) {
                                            key.functionInfoBeans.forEach(function (fun) {
                                                endTd += stringFormat(template.list, fun.functionName, "fun_" + fun.functionId, "endTd" + fun.resourceId, fun.resourceId);
                                                endClass = "endTd" + fun.resourceId;
                                                
                                            })
                                        } else {
                                            endTd += stringFormat(template.list, "", "", "", "");
                                        }
                                    })
                                } else {
                                    thirdTd += stringFormat(template.list, "", "", "", "");
                                }
                            })
                        } else {
                            sencendTd += stringFormat(template.list, "", "", "", "");
                        }
                        $("#functionTable").append(stringFormat(template.Main, firstTd, sencendTd, thirdTd, endTd));
                        if (item.childs && item.childs.length > 0) {
                            if (endClass) {
                               var data= _this.reArr(arr)
                               for(var datas in data){
                                   console.log(data)
                                $("#thirdTd"+data[datas].value).height(Math.floor($("." + endClass).height())*data[datas].count)
                               }
                            }
                            if (thirdCalss) {
                                $("." + sencendClass).height(Math.floor($("." + thirdCalss).height()) * $("." + thirdCalss).length)
                                $("." + sencendClass).css("lineHeight", $("." + sencendClass).height() + "px")
                            }
                            if (sencendClass) {
                                $("." + firstCalss).height(Math.floor($("." + sencendClass).height()) * $("." + sencendClass).length)
                            }

                            $(".mains .miandd").css("height", $("." + firstCalss).height())
                        }

                    });

                }
                _this.binds();
            })

        },
        reArr: function (arr) {//数值去重，并统计重复个数
            var i = 0, maxI,
                item = {};
            arr.sort(function (x, y) { return x - y; });
            for (i = 0; maxI = arr.length, i < maxI; i += 1) {
                var key = arr[i], obj = {};

                if (item[key]) {
                    item[key].count++;
                } else {
                    obj.value = arr[i];
                    obj.count = arr[i] == arr[i + 1] ? 2 : 1;
                    item[key] = obj;
                }
                if (arr[i] == arr[i + 1]) {
                    arr.splice(i + 1, 1);
                }

            }

            return item;
        },
        binds: function () {
            var _this = this;
            $("#functionTable td").on("click", "div", function (e) {
                var target = e.target;
                var id = $(target).attr("id");
                var reId = $(target).attr("dataId");
                // console.log(id).split("_")
                if (id) {
                    if (id.split("_")[0] == 'fun') {
                        var ids = id.split("_")[1]
                        layer.open({
                            content: template.btn,
                            // success: function(layero, index){
                            //   console.log(layero, index);
                            // }
                        });
                        $(".layui-layer-btn a").css("display", 'none')
                        setTimeout(function () {
                            $("#functonBtn_add").on("click", function () {

                            })
                            $("#functonBtn_edit").on("click", function () {

                            })
                            $("#functonBtn_delete").on("click", function () {
                                layer.confirm('您确定删除吗？', {
                                    btn: ['确定', '取消'] //按钮
                                }, function () {
                                    postAjax("function/del", {
                                        id: ids
                                    }, function (data) {
                                        if (data.code == 0) {
                                            layer.msg("删除成功");
                                            _this.getFunction();
                                        } else {
                                            return false;
                                        }
                                    })
                                }, function () {
                                    // return false;
                                });
                            })
                        }, 300)
                    }
                }
            })
        }
    }
    page.init();
});