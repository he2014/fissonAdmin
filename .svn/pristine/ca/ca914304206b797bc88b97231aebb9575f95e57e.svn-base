$(document).ready(function() {
    var user_taable = window['user_taable'] = {
        init: function() {
            var _this = this;
            new Promise(function(resolve) {
                _this.getUserList(1);
                resolve();
            }).then(function() {
                util.table.allSelect(_this.selected);

            })
        },
        binds: function() {
            var _this = this;
            $("table thead th input:checkbox").closest("table").find("tr > td:first-child input:checkbox").on("click", function() {
                util.table.selectNode(user_taable.selected)
            })
            $('.userDelete').on("click", function() {
                var userId = $(this).parent().attr('data-userId')
                _this.admin_del(userId);
            })
            $('.userEdit').on("click", function() {
                var userIds = $(this).parent().attr('data-userId')
                _this.admin_edit(userIds);
            })
            $('.userRole').on("click", function() {
                var userIda = $(this).parent().attr('data-userId')
                _this.admin_role(userIda);
            })
            $('.editorPage').on("click", function() {
                var roleIdPage = $(this).attr('data-roleId')
                var roleNamePage = $(this).attr('data-roleName')
                // console.log(roleIdPage)
                _this.page_edit(roleIdPage);
                _this.page_edit_name(roleNamePage);
            })
            $('.editorFun').on("click", function() {
                var roleIdFun = $(this).attr('data-roleId')
                var roleNameFun = $(this).attr('data-roleName')
                // console.log(roleNameFun)
                _this.function_edit(roleIdFun);
                _this.function_edit_name(roleNameFun);
            })
        },
        // 获取数据
        getUserList: function(page) {
            var _this = this;
            var datas = {
                page: page,
                size: 20
            };
            $.ajax({
                type: "get",
                url: paths + "sysuser/manage/list",
                async: true,
                dataType: 'json',
                data: datas,
                success: function(data) {
                    // console.log(data)
                    if (data.code == 0) {
                        if (data.dataInfo.list && data.dataInfo.list.length > 0) {
                            var pageCount = data.dataInfo.total / datas.size;
                            var count = pageCount > Math.floor(pageCount) ? Math.floor(pageCount) + 1 : pageCount;
                            var htmls = _this.getListHtmls(data.dataInfo.list);
                            $("#UserList").html(htmls);
                            _this.binds();
                            util.page_html("user_layerPage", page, count, 'user_taable.getUserList');
                        } else {
                            $("#UserList").html(' ');
                        }
                    }
                },
                error: function(e) {
                    console.log(e)
                }
            });
        },
        // 获取角色数据
        getUserRoleList: function() {
            var _this = this;
            var datas = {
                // id: userId
            };
            $.ajax({
                type: "get",
                url: paths + "sysuser/manage/role/1",
                async: true,
                dataType: 'json',
                data: datas,
                success: function(data) {
                    // console.log(data)
                    if (data.code == 0) {
                        if (data.dataInfo && data.dataInfo.length > 0) {
                            var tables = _this.getRoleListHtmls(data.dataInfo);
                            $("#UserRoleList").html(tables);
                            _this.binds();
                        } else {
                            $("#UserRoleList").html(' ');
                        }
                    }
                },
                error: function(e) {
                    console.log(e)
                }
            });
        },
        // 批量删除
        selected: function(data) {
            $("#batchDelete").on("click", function() {
                $.ajax({
                    type: 'POST',
                    url: paths + 'sysuser/manage/delBatch',
                    dataType: 'json',
                    data: {
                        ids: data.join(",")
                    },
                    success: function(data) {
                        if (data.code == 0) {
                            layer.msg('已删除!', {
                                icon: 1,
                                time: 1000
                            });
                            user_taable.getUserList(1);
                        }
                    },
                    error: function(data) {
                        console.log(data.msg);
                    },
                });
            })
        },
        /*管理员-删除*/
        admin_del: function(userId) {
            var datas = {
                ui: userId
            };
            layer.confirm('确认要删除吗？', function(index) {
                $.ajax({
                    type: 'POST',
                    url: paths + 'sysuser/manage/del',
                    dataType: 'json',
                    data: datas,
                    success: function(data) {
                        if (data.code == 0 && data.dataInfo > 0) {
                            $(userId).parents("tr").remove();
                            layer.msg('已删除!', {
                                icon: 1,
                                time: 1000
                            });
                            user_taable.getUserList(1);
                        }
                    },
                    error: function(data) {
                        console.log(data.msg);
                    },
                });
            });
        },
        /*管理员-修改角色*/
        admin_role: function(userIda) {
            $("#editRole").modal("show")
            user_taable.getUserRoleList(1);
            // $(".edit-User").unbind('click').click(function(event) {
            //     // console.log(userIds);
            //     var un = $(".input-userName").val();
            //     var ps = $(".input-passWord").val();
            //
            //
            // });
        },
        /*管理员-编辑*/
        admin_edit: function(userIds) {
            $("#editUser").modal("show")
            $(".edit-User").unbind('click').click(function(event) {
                // console.log(userIds);
                var un = $(".input-userName").val();
                var ps = $(".input-passWord").val();
                var regex = new RegExp(/^(?![^a-zA-Z]+$)(?!\D+$)/);
                if (!un && !ps) {
                    $.Huimodalalert('用户名、密码不能为空！', 1500)
                } else if (!un) {
                    $.Huimodalalert('用户名不能为空！', 1500)
                } else if (!ps) {
                    $.Huimodalalert('密码不能为空！', 1500)
                }
                if (ps && un) {
                    if (!regex.test(ps)) {
                        $.Huimodalalert('密码格式不正确！', 1500)
                    } else if (!regex.test(ps) && (ps.length < 6 || ps.length > 20)) {
                        $.Huimodalalert('密码格式不正确！', 1500)
                    } else if (un.length < 6) {
                        $.Huimodalalert('用户名格式不正确！', 1500)
                    }
                    if (regex.test(ps) && un.length >= 6 && ps.length >= 6 && ps.length <= 20) {
                        var data = {
                            ui: userIds,
                            un: un,
                            ps: ps
                        }
                        postAjax("sysuser/manage/update/info", data, function(data) {
                            if (data.code == 0 && data.dataInfo > 0) {
                                $.Huimodalalert('用户信息修改成功！', 1500)
                                $("#editUser").modal("hide");
                                $(".input-userName").val("");
                                $(".input-passWord").val("");
                                user_taable.getUserList(1);
                            }
                        })
                    }
                }
            });
        },
        page_edit: function(roleIdPage) {
            $("#pageEdit").modal("show")
        },
        page_edit_name(roleNamePage) {
            $(".pagePrompt").html(
                "角色：" + roleNamePage + "的页面权限"
            );
        },
        function_edit: function(roleIdFun) {
            $("#functionEdit").modal("show")
        },
        function_edit_name(roleNameFun) {
            $(".functionPrompt").html(
                "角色：" + roleNameFun + "的功能权限"
            );
        },
        getListHtmls: function(datas) {
            var htmls = '';
            $.each(datas, function(index, item) {
                htmls += '<tr class="text-c"><td><input type="checkbox" value="' + item.userId + '" name=""></td><td class="userId">' + item.userId + '</td><td>' + item.loginName + '</td><td>' + getTimes(item.createTime) + '</td><td class="td-manage"><a data-userId="' + item.userId + '" title="编辑角色" href="javascript:;" class="ml-3" style="text-decoration:none"><i class="Hui-iconfont userRole">&#xe62c;</i></a><a data-userId="' + item.userId + '" title="编辑" href="javascript:;" class="ml-5" style="text-decoration:none"><i class="Hui-iconfont userEdit">&#xe6df;</i></a><a  data-userId="' + item.userId + '" title="删除" href="javascript:;" class="ml-7" style="text-decoration:none"><i  class="Hui-iconfont userDelete">&#xe6e2;</i></a><a data-roleId="' + item.roleId + '" data-roleName="' + item.roleName + '" href="javascript:;" class="btn btn-primary size-S radius editorPage">修改页面权限</a><a data-roleId="' + item.roleId + '" data-roleName="' + item.roleName + '" href="javascript:;" class="btn btn-primary size-S radius editorFun">修改功能权限</a></td></tr>';
            })
            return htmls;
        },
        getRoleListHtmls: function(datas) {
            var tables = '';
            $.each(datas, function(indexs, items) {
                tables += '<tr class="text-r"><td class="roleId">' + items.roleId + '</td><td>' + items.roleName + '</td><td>' + getTimes(items.createTime) + '</td><td><input type="checkbox" value="' + items.roleId + '" name="">' + items.permitted + '</td></tr>';
            })
            return tables;
        },
    }
    user_taable.init()
})
